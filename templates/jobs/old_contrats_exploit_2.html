<html>
<head>
    <title>Contrats</title>
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    {% load staticfiles %}
    <link rel="stylesheet" type="text/css" href="{% static "css/style.css" %}">
</head>

<body class="starter-template">

    <div class="btn-group">

      <button type="button" id="week" class="btn btn-default">Semaine</button>
      <button type="button" id="month" class="btn btn-default">Mois</button>
      <button type="button" id="year" class="btn btn-default">Ann√©e</button>
    </div>
    <script type="text/javascript">
      //Width and height
      var w = 600;
      var h = 100;
      $(".btn-default").click(function() {
        // Remove div if they exist before creating them again
        $( "div.contrats").remove();
        periode = $(this).attr('id');

        //----------------------
        $.ajax({  
              type: "GET",
              url: '/contrats_json',
              data: {mode_aggreg: periode},
              dataType: "json",
              success: function(data) {
                  dataset = data.types;
                  max = data.max;
                  //-----------------------D3-----------------------
                  // Create divs from the json's keys
                  $.each(dataset, function(key, value) {
                      $("<div id ='" + key +"' class='contrats'></div>").appendTo("body");

                      var dataset_type = value;

                      var xScale_type = d3.scale.ordinal()
                                      .domain(d3.range(dataset_type.length))
                                      .rangeRoundBands([0, w], 0.05);

                      var yScale_type = d3.scale.linear()
                                      .domain([0, max])
                                      .range([0, h]);
                      
                      //Create SVG element
                      var svg_type = d3.select("div#" + key)
                                  .append("svg")
                                  .attr("width", w)
                                  .attr("height", h);

                      //Create bars
                      svg_type.selectAll("rect")
                         .data(dataset_type)
                         .enter()
                         .append("rect")
                         .attr("x", function(d, i) {
                              return xScale_type(i);
                         })
                         .attr("y", function(d) {
                              return h - yScale_type(d);
                         })
                         .attr("width", xScale_type.rangeBand())
                         .attr("height", function(d) {
                              return yScale_type(d);
                         });

                      //Create labels
                      svg_type.selectAll("text")
                         .data(dataset_type)
                         .enter()
                         .append("text")
                         .text(function(d) {
                              return d;
                         })
                         .attr("text-anchor", "middle")
                         .attr("x", function(d, i) {
                              return xScale_type(i) + xScale_type.rangeBand() / 2;
                         })
                         .attr("y", function(d) {
                              return h - yScale_type(d) + 14;
                         })
                         .attr("font-family", "sans-serif")
                         .attr("font-size", "11px")
                         .attr("fill", "white");

        });
      // Ordering the divs
      $("#cdd").insertAfter("#cdi");
      $("#fpt").insertAfter("#cdd");
      $("#stage").insertAfter("#fpt");
      $("#apprentissage").insertAfter("#stage");
      $("#autre").insertAfter("#apprentissage");
                  //---------FIN D3-------------
              }
            });
      });
    </script>
</body>
</html>